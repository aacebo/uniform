import { Injectable, Inject } from '@angular/core';
import { Overlay } from '@angular/cdk/overlay';
import { ComponentPortal, PortalInjector } from '@angular/cdk/portal';
import { take } from 'rxjs/operators';
import { UniToastPosition } from './toast-position.enum';
import { UniToastComponent } from './toast.component';
import { UNI_TOAST_OPTIONS } from './toast-options.constant';
import { UNI_TOAST_CONFIG } from './toast-config.constant';
import { UniToastRef } from './toast-ref.class';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/overlay";
var UniToastService = /** @class */ (function () {
    function UniToastService(_config, _overlay) {
        this._config = _config;
        this._overlay = _overlay;
        this._index = -1;
        this._toasts = [];
    }
    Object.defineProperty(UniToastService.prototype, "_id", {
        get: function () {
            this._index++;
            return this._index;
        },
        enumerable: true,
        configurable: true
    });
    UniToastService.prototype.open = function (options) {
        return this._create(UniToastComponent, options);
    };
    UniToastService.prototype.create = function (component, options) {
        return this._create(component, options);
    };
    UniToastService.prototype.remove = function (id) {
        for (var i = 0; i < this._toasts.length; i++) {
            if (this._toasts[i].id === id) {
                this._toasts.splice(i, 1);
                return i;
            }
        }
        return -1;
    };
    UniToastService.prototype.find = function (id) {
        return this._toasts.find(function (t) { return t.id === id; });
    };
    UniToastService.prototype._create = function (component, options) {
        var _this = this;
        var latest = this._getLatestByPosition(options.position);
        var position = latest ? latest.ref.position : undefined;
        var overlayRef = this._overlay.create({
            panelClass: options.panelClass,
            positionStrategy: this._getPositionStrategy(options.position, position),
        });
        var toastRef = new UniToastRef(overlayRef);
        var portal = new ComponentPortal(component, null, this._getInjector(toastRef, options));
        var instance = overlayRef.attach(portal).instance;
        var toast = {
            id: this._id,
            type: options.type,
            position: options.position,
            component: instance,
            ref: toastRef,
        };
        toastRef.closed$.pipe(take(1)).subscribe(function () {
            _this.remove(toast.id);
            _this._updatePositions(toast.position);
        });
        this._toasts.push(toast);
        return toast;
    };
    UniToastService.prototype._getInjector = function (ref, options) {
        var tokens = new WeakMap();
        tokens.set(UniToastRef, ref);
        tokens.set(UNI_TOAST_OPTIONS, options);
        tokens.set(UNI_TOAST_CONFIG, this._config);
        return new PortalInjector(null, tokens);
    };
    UniToastService.prototype._getPositionStrategy = function (position, latest) {
        var pb = this._overlay.position().global();
        if (position === UniToastPosition.TopLeft) {
            return pb.top(this._getLatestMargin(position, latest)).left(this._config.margin + "px");
        }
        else if (position === UniToastPosition.TopRight) {
            return pb.top(this._getLatestMargin(position, latest)).right(this._config.margin + "px");
        }
        else if (position === UniToastPosition.BottomLeft) {
            if (!latest) {
                return pb.bottom(this._getLatestMargin(position, latest)).left(this._config.margin + "px");
            }
            else {
                return pb.top(this._getLatestMargin(position, latest)).left(this._config.margin + "px");
            }
        }
        if (!latest) {
            return pb.bottom(this._getLatestMargin(position, latest)).right(this._config.margin + "px");
        }
        else {
            return pb.top(this._getLatestMargin(position, latest)).right(this._config.margin + "px");
        }
    };
    UniToastService.prototype._getLatestMargin = function (position, latest) {
        var key = (position === UniToastPosition.TopLeft || position === UniToastPosition.TopRight) ? 'bottom' : 'top';
        if (key === 'bottom') {
            return latest ? latest[key] + this._config.margin + "px" : this._config.margin + "px";
        }
        else {
            return latest ? latest[key] - latest.height - this._config.margin + "px" : this._config.margin + "px";
        }
    };
    UniToastService.prototype._getToastsByPosition = function (position) {
        return this._toasts.filter(function (t) { return t.position === position; })
            .sort(function (a, b) { return a.id - b.id; });
    };
    UniToastService.prototype._getLatestByPosition = function (position) {
        var toasts = this._getToastsByPosition(position);
        return toasts[toasts.length - 1];
    };
    UniToastService.prototype._updatePositions = function (position) {
        var toasts = this._getToastsByPosition(position);
        for (var i = 0; i < toasts.length; i++) {
            toasts[i].ref.updatePosition(this._getPositionStrategy(toasts[i].position, toasts[i - 1] ? toasts[i - 1].ref.position : undefined));
        }
    };
    UniToastService.ɵfac = function UniToastService_Factory(t) { return new (t || UniToastService)(i0.ɵɵinject(UNI_TOAST_CONFIG), i0.ɵɵinject(i1.Overlay)); };
    UniToastService.ɵprov = i0.ɵɵdefineInjectable({ token: UniToastService, factory: UniToastService.ɵfac });
    return UniToastService;
}());
export { UniToastService };
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(UniToastService, [{
        type: Injectable
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [UNI_TOAST_CONFIG]
            }] }, { type: i1.Overlay }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9hc3Quc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B1bmlmb3JtL2NvbXBvbmVudHMvIiwic291cmNlcyI6WyJsaWIvdG9hc3QvdG9hc3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQWlCLE1BQU0scUJBQXFCLENBQUM7QUFDckYsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBS3RDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzdELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzNELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQzs7O0FBRWhEO0lBVUUseUJBQzZDLE9BQXdCLEVBQ2xELFFBQWlCO1FBRFMsWUFBTyxHQUFQLE9BQU8sQ0FBaUI7UUFDbEQsYUFBUSxHQUFSLFFBQVEsQ0FBUztRQVY1QixXQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDSCxZQUFPLEdBQWdCLEVBQUUsQ0FBQztJQVV4QyxDQUFDO0lBUkosc0JBQVksZ0NBQUc7YUFBZjtZQUNFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNkLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUNyQixDQUFDOzs7T0FBQTtJQU9ELDhCQUFJLEdBQUosVUFBSyxPQUF5QjtRQUM1QixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLENBQUM7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aElZLGVBQWU7a0RBQWYsZUFBZTtjQUQzQixVQUFVOztzQkFXTixNQUFNO3VCQUFDLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT3ZlcmxheSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCwgUG9ydGFsSW5qZWN0b3IsIENvbXBvbmVudFR5cGUgfSBmcm9tICdAYW5ndWxhci9jZGsvcG9ydGFsJztcbmltcG9ydCB7IHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IElVbmlUb2FzdCB9IGZyb20gJy4vdG9hc3QuaW50ZXJmYWNlJztcbmltcG9ydCB7IElVbmlUb2FzdE9wdGlvbnMgfSBmcm9tICcuL3RvYXN0LW9wdGlvbnMuaW50ZXJmYWNlJztcbmltcG9ydCB7IElVbmlUb2FzdENvbmZpZyB9IGZyb20gJy4vdG9hc3QtY29uZmlnLmludGVyZmFjZSc7XG5pbXBvcnQgeyBVbmlUb2FzdFBvc2l0aW9uIH0gZnJvbSAnLi90b2FzdC1wb3NpdGlvbi5lbnVtJztcbmltcG9ydCB7IFVuaVRvYXN0Q29tcG9uZW50IH0gZnJvbSAnLi90b2FzdC5jb21wb25lbnQnO1xuaW1wb3J0IHsgVU5JX1RPQVNUX09QVElPTlMgfSBmcm9tICcuL3RvYXN0LW9wdGlvbnMuY29uc3RhbnQnO1xuaW1wb3J0IHsgVU5JX1RPQVNUX0NPTkZJRyB9IGZyb20gJy4vdG9hc3QtY29uZmlnLmNvbnN0YW50JztcbmltcG9ydCB7IFVuaVRvYXN0UmVmIH0gZnJvbSAnLi90b2FzdC1yZWYuY2xhc3MnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVW5pVG9hc3RTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBfaW5kZXggPSAtMTtcbiAgcHJpdmF0ZSByZWFkb25seSBfdG9hc3RzOiBJVW5pVG9hc3RbXSA9IFtdO1xuXG4gIHByaXZhdGUgZ2V0IF9pZCgpIHtcbiAgICB0aGlzLl9pbmRleCsrO1xuICAgIHJldHVybiB0aGlzLl9pbmRleDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoVU5JX1RPQVNUX0NPTkZJRykgcHJpdmF0ZSByZWFkb25seSBfY29uZmlnOiBJVW5pVG9hc3RDb25maWcsXG4gICAgcHJpdmF0ZSByZWFkb25seSBfb3ZlcmxheTogT3ZlcmxheSxcbiAgKSB7fVxuXG4gIG9wZW4ob3B0aW9uczogSVVuaVRvYXN0T3B0aW9ucykge1xuICAgIHJldHVybiB0aGlzLl9jcmVhdGUoVW5pVG9hc3RDb21wb25lbnQsIG9wdGlvbnMpO1xuICB9XG5cbiAgY3JlYXRlPFQ+KGNvbXBvbmVudDogQ29tcG9uZW50VHlwZTxUPiwgb3B0aW9uczogSVVuaVRvYXN0T3B0aW9ucykge1xuICAgIHJldHVybiB0aGlzLl9jcmVhdGUoY29tcG9uZW50LCBvcHRpb25zKTtcbiAgfVxuXG4gIHJlbW92ZShpZDogbnVtYmVyKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl90b2FzdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmICh0aGlzLl90b2FzdHNbaV0uaWQgPT09IGlkKSB7XG4gICAgICAgIHRoaXMuX3RvYXN0cy5zcGxpY2UoaSwgMSk7XG4gICAgICAgIHJldHVybiBpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiAtMTtcbiAgfVxuXG4gIGZpbmQ8VCA9IGFueT4oaWQ6IG51bWJlcik6IElVbmlUb2FzdDxUPiB7XG4gICAgcmV0dXJuIHRoaXMuX3RvYXN0cy5maW5kKHQgPT4gdC5pZCA9PT0gaWQpO1xuICB9XG5cbiAgcHJpdmF0ZSBfY3JlYXRlPFQ+KGNvbXBvbmVudDogQ29tcG9uZW50VHlwZTxUPiwgb3B0aW9uczogSVVuaVRvYXN0T3B0aW9ucyk6IElVbmlUb2FzdDxUPiB7XG4gICAgY29uc3QgbGF0ZXN0ID0gdGhpcy5fZ2V0TGF0ZXN0QnlQb3NpdGlvbihvcHRpb25zLnBvc2l0aW9uKTtcbiAgICBjb25zdCBwb3NpdGlvbiA9IGxhdGVzdCA/IGxhdGVzdC5yZWYucG9zaXRpb24gOiB1bmRlZmluZWQ7XG4gICAgY29uc3Qgb3ZlcmxheVJlZiA9IHRoaXMuX292ZXJsYXkuY3JlYXRlKHtcbiAgICAgIHBhbmVsQ2xhc3M6IG9wdGlvbnMucGFuZWxDbGFzcyxcbiAgICAgIHBvc2l0aW9uU3RyYXRlZ3k6IHRoaXMuX2dldFBvc2l0aW9uU3RyYXRlZ3kob3B0aW9ucy5wb3NpdGlvbiwgcG9zaXRpb24pLFxuICAgIH0pO1xuXG4gICAgY29uc3QgdG9hc3RSZWYgPSBuZXcgVW5pVG9hc3RSZWYob3ZlcmxheVJlZik7XG4gICAgY29uc3QgcG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbChjb21wb25lbnQsIG51bGwsIHRoaXMuX2dldEluamVjdG9yKHRvYXN0UmVmLCBvcHRpb25zKSk7XG4gICAgY29uc3QgaW5zdGFuY2UgPSBvdmVybGF5UmVmLmF0dGFjaChwb3J0YWwpLmluc3RhbmNlO1xuICAgIGNvbnN0IHRvYXN0OiBJVW5pVG9hc3Q8VD4gPSB7XG4gICAgICBpZDogdGhpcy5faWQsXG4gICAgICB0eXBlOiBvcHRpb25zLnR5cGUsXG4gICAgICBwb3NpdGlvbjogb3B0aW9ucy5wb3NpdGlvbixcbiAgICAgIGNvbXBvbmVudDogaW5zdGFuY2UsXG4gICAgICByZWY6IHRvYXN0UmVmLFxuICAgIH07XG5cbiAgICB0b2FzdFJlZi5jbG9zZWQkLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMucmVtb3ZlKHRvYXN0LmlkKTtcbiAgICAgIHRoaXMuX3VwZGF0ZVBvc2l0aW9ucyh0b2FzdC5wb3NpdGlvbik7XG4gICAgfSk7XG5cbiAgICB0aGlzLl90b2FzdHMucHVzaCh0b2FzdCk7XG5cbiAgICByZXR1cm4gdG9hc3Q7XG4gIH1cblxuICBwcml2YXRlIF9nZXRJbmplY3RvcihyZWY6IFVuaVRvYXN0UmVmLCBvcHRpb25zOiBJVW5pVG9hc3RPcHRpb25zKSB7XG4gICAgY29uc3QgdG9rZW5zID0gbmV3IFdlYWtNYXAoKTtcblxuICAgIHRva2Vucy5zZXQoVW5pVG9hc3RSZWYsIHJlZik7XG4gICAgdG9rZW5zLnNldChVTklfVE9BU1RfT1BUSU9OUywgb3B0aW9ucyk7XG4gICAgdG9rZW5zLnNldChVTklfVE9BU1RfQ09ORklHLCB0aGlzLl9jb25maWcpO1xuXG4gICAgcmV0dXJuIG5ldyBQb3J0YWxJbmplY3RvcihudWxsLCB0b2tlbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0UG9zaXRpb25TdHJhdGVneShwb3NpdGlvbjogVW5pVG9hc3RQb3NpdGlvbiwgbGF0ZXN0OiBDbGllbnRSZWN0IHwgRE9NUmVjdCkge1xuICAgIGNvbnN0IHBiID0gdGhpcy5fb3ZlcmxheS5wb3NpdGlvbigpLmdsb2JhbCgpO1xuXG4gICAgaWYgKHBvc2l0aW9uID09PSBVbmlUb2FzdFBvc2l0aW9uLlRvcExlZnQpIHtcbiAgICAgIHJldHVybiBwYi50b3AodGhpcy5fZ2V0TGF0ZXN0TWFyZ2luKHBvc2l0aW9uLCBsYXRlc3QpKS5sZWZ0KGAke3RoaXMuX2NvbmZpZy5tYXJnaW59cHhgKTtcbiAgICB9IGVsc2UgaWYgKHBvc2l0aW9uID09PSBVbmlUb2FzdFBvc2l0aW9uLlRvcFJpZ2h0KSB7XG4gICAgICByZXR1cm4gcGIudG9wKHRoaXMuX2dldExhdGVzdE1hcmdpbihwb3NpdGlvbiwgbGF0ZXN0KSkucmlnaHQoYCR7dGhpcy5fY29uZmlnLm1hcmdpbn1weGApO1xuICAgIH0gZWxzZSBpZiAocG9zaXRpb24gPT09IFVuaVRvYXN0UG9zaXRpb24uQm90dG9tTGVmdCkge1xuICAgICAgaWYgKCFsYXRlc3QpIHtcbiAgICAgICAgcmV0dXJuIHBiLmJvdHRvbSh0aGlzLl9nZXRMYXRlc3RNYXJnaW4ocG9zaXRpb24sIGxhdGVzdCkpLmxlZnQoYCR7dGhpcy5fY29uZmlnLm1hcmdpbn1weGApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHBiLnRvcCh0aGlzLl9nZXRMYXRlc3RNYXJnaW4ocG9zaXRpb24sIGxhdGVzdCkpLmxlZnQoYCR7dGhpcy5fY29uZmlnLm1hcmdpbn1weGApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghbGF0ZXN0KSB7XG4gICAgICByZXR1cm4gcGIuYm90dG9tKHRoaXMuX2dldExhdGVzdE1hcmdpbihwb3NpdGlvbiwgbGF0ZXN0KSkucmlnaHQoYCR7dGhpcy5fY29uZmlnLm1hcmdpbn1weGApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcGIudG9wKHRoaXMuX2dldExhdGVzdE1hcmdpbihwb3NpdGlvbiwgbGF0ZXN0KSkucmlnaHQoYCR7dGhpcy5fY29uZmlnLm1hcmdpbn1weGApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2dldExhdGVzdE1hcmdpbihwb3NpdGlvbjogVW5pVG9hc3RQb3NpdGlvbiwgbGF0ZXN0PzogQ2xpZW50UmVjdCB8IERPTVJlY3QpIHtcbiAgICBjb25zdCBrZXk6IGtleW9mIENsaWVudFJlY3QgPSAocG9zaXRpb24gPT09IFVuaVRvYXN0UG9zaXRpb24uVG9wTGVmdCB8fCBwb3NpdGlvbiA9PT0gVW5pVG9hc3RQb3NpdGlvbi5Ub3BSaWdodCkgPyAnYm90dG9tJyA6ICd0b3AnO1xuXG4gICAgaWYgKGtleSA9PT0gJ2JvdHRvbScpIHtcbiAgICAgIHJldHVybiBsYXRlc3QgPyBgJHtsYXRlc3Rba2V5XSArIHRoaXMuX2NvbmZpZy5tYXJnaW59cHhgIDogYCR7dGhpcy5fY29uZmlnLm1hcmdpbn1weGA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBsYXRlc3QgPyBgJHtsYXRlc3Rba2V5XSAtIGxhdGVzdC5oZWlnaHQgLSB0aGlzLl9jb25maWcubWFyZ2lufXB4YCA6IGAke3RoaXMuX2NvbmZpZy5tYXJnaW59cHhgO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2dldFRvYXN0c0J5UG9zaXRpb24ocG9zaXRpb246IFVuaVRvYXN0UG9zaXRpb24pIHtcbiAgICByZXR1cm4gdGhpcy5fdG9hc3RzLmZpbHRlcih0ID0+IHQucG9zaXRpb24gPT09IHBvc2l0aW9uKVxuICAgICAgICAgICAgICAgICAgICAgICAuc29ydCgoYSwgYikgPT4gYS5pZCAtIGIuaWQpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0TGF0ZXN0QnlQb3NpdGlvbihwb3NpdGlvbjogVW5pVG9hc3RQb3NpdGlvbikge1xuICAgIGNvbnN0IHRvYXN0cyA9ICB0aGlzLl9nZXRUb2FzdHNCeVBvc2l0aW9uKHBvc2l0aW9uKTtcbiAgICByZXR1cm4gdG9hc3RzW3RvYXN0cy5sZW5ndGggLSAxXTtcbiAgfVxuXG4gIHByaXZhdGUgX3VwZGF0ZVBvc2l0aW9ucyhwb3NpdGlvbjogVW5pVG9hc3RQb3NpdGlvbikge1xuICAgIGNvbnN0IHRvYXN0cyA9ICB0aGlzLl9nZXRUb2FzdHNCeVBvc2l0aW9uKHBvc2l0aW9uKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG9hc3RzLmxlbmd0aDsgaSsrKSB7XG4gICAgICB0b2FzdHNbaV0ucmVmLnVwZGF0ZVBvc2l0aW9uKHRoaXMuX2dldFBvc2l0aW9uU3RyYXRlZ3koXG4gICAgICAgIHRvYXN0c1tpXS5wb3NpdGlvbixcbiAgICAgICAgdG9hc3RzW2kgLSAxXSA/IHRvYXN0c1tpIC0gMV0ucmVmLnBvc2l0aW9uIDogdW5kZWZpbmVkLFxuICAgICAgKSk7XG4gICAgfVxuICB9XG59XG4iXX0=