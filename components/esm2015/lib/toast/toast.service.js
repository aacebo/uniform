import { Injectable, Inject } from '@angular/core';
import { Overlay } from '@angular/cdk/overlay';
import { ComponentPortal, PortalInjector } from '@angular/cdk/portal';
import { take } from 'rxjs/operators';
import { UniToastPosition } from './toast-position.enum';
import { UniToastComponent } from './toast.component';
import { UNI_TOAST_OPTIONS } from './toast-options.constant';
import { UNI_TOAST_CONFIG } from './toast-config.constant';
import { UniToastRef } from './toast-ref.class';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/overlay";
export class UniToastService {
    constructor(_config, _overlay) {
        this._config = _config;
        this._overlay = _overlay;
        this._index = -1;
        this._toasts = [];
    }
    get _id() {
        this._index++;
        return this._index;
    }
    open(options) {
        return this._create(UniToastComponent, options);
    }
    create(component, options) {
        return this._create(component, options);
    }
    remove(id) {
        for (let i = 0; i < this._toasts.length; i++) {
            if (this._toasts[i].id === id) {
                this._toasts.splice(i, 1);
                return i;
            }
        }
        return -1;
    }
    find(id) {
        return this._toasts.find(t => t.id === id);
    }
    _create(component, options) {
        const latest = this._getLatestByPosition(options.position);
        const position = latest ? latest.ref.position : undefined;
        const overlayRef = this._overlay.create({
            panelClass: options.panelClass,
            positionStrategy: this._getPositionStrategy(options.position, position),
        });
        const toastRef = new UniToastRef(overlayRef);
        const portal = new ComponentPortal(component, null, this._getInjector(toastRef, options));
        const instance = overlayRef.attach(portal).instance;
        const toast = {
            id: this._id,
            type: options.type,
            position: options.position,
            component: instance,
            ref: toastRef,
        };
        toastRef.closed$.pipe(take(1)).subscribe(() => {
            this.remove(toast.id);
            this._updatePositions(toast.position);
        });
        this._toasts.push(toast);
        return toast;
    }
    _getInjector(ref, options) {
        const tokens = new WeakMap();
        tokens.set(UniToastRef, ref);
        tokens.set(UNI_TOAST_OPTIONS, options);
        tokens.set(UNI_TOAST_CONFIG, this._config);
        return new PortalInjector(null, tokens);
    }
    _getPositionStrategy(position, latest) {
        const pb = this._overlay.position().global();
        if (position === UniToastPosition.TopLeft) {
            return pb.top(this._getLatestMargin(position, latest)).left(`${this._config.margin}px`);
        }
        else if (position === UniToastPosition.TopRight) {
            return pb.top(this._getLatestMargin(position, latest)).right(`${this._config.margin}px`);
        }
        else if (position === UniToastPosition.BottomLeft) {
            if (!latest) {
                return pb.bottom(this._getLatestMargin(position, latest)).left(`${this._config.margin}px`);
            }
            else {
                return pb.top(this._getLatestMargin(position, latest)).left(`${this._config.margin}px`);
            }
        }
        if (!latest) {
            return pb.bottom(this._getLatestMargin(position, latest)).right(`${this._config.margin}px`);
        }
        else {
            return pb.top(this._getLatestMargin(position, latest)).right(`${this._config.margin}px`);
        }
    }
    _getLatestMargin(position, latest) {
        const key = (position === UniToastPosition.TopLeft || position === UniToastPosition.TopRight) ? 'bottom' : 'top';
        if (key === 'bottom') {
            return latest ? `${latest[key] + this._config.margin}px` : `${this._config.margin}px`;
        }
        else {
            return latest ? `${latest[key] - latest.height - this._config.margin}px` : `${this._config.margin}px`;
        }
    }
    _getToastsByPosition(position) {
        return this._toasts.filter(t => t.position === position)
            .sort((a, b) => a.id - b.id);
    }
    _getLatestByPosition(position) {
        const toasts = this._getToastsByPosition(position);
        return toasts[toasts.length - 1];
    }
    _updatePositions(position) {
        const toasts = this._getToastsByPosition(position);
        for (let i = 0; i < toasts.length; i++) {
            toasts[i].ref.updatePosition(this._getPositionStrategy(toasts[i].position, toasts[i - 1] ? toasts[i - 1].ref.position : undefined));
        }
    }
}
UniToastService.ɵfac = function UniToastService_Factory(t) { return new (t || UniToastService)(i0.ɵɵinject(UNI_TOAST_CONFIG), i0.ɵɵinject(i1.Overlay)); };
UniToastService.ɵprov = i0.ɵɵdefineInjectable({ token: UniToastService, factory: UniToastService.ɵfac });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(UniToastService, [{
        type: Injectable
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [UNI_TOAST_CONFIG]
            }] }, { type: i1.Overlay }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9hc3Quc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B1bmlmb3JtL2NvbXBvbmVudHMvIiwic291cmNlcyI6WyJsaWIvdG9hc3QvdG9hc3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQWlCLE1BQU0scUJBQXFCLENBQUM7QUFDckYsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBS3RDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzdELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzNELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQzs7O0FBR2hELE1BQU0sT0FBTyxlQUFlO0lBUzFCLFlBQzZDLE9BQXdCLEVBQ2xELFFBQWlCO1FBRFMsWUFBTyxHQUFQLE9BQU8sQ0FBaUI7UUFDbEQsYUFBUSxHQUFSLFFBQVEsQ0FBUztRQVY1QixXQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDSCxZQUFPLEdBQWdCLEVBQUUsQ0FBQztJQVV4QyxDQUFDO0lBUkosSUFBWSxHQUFHO1FBQ2IsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2QsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3JCLENBQUM7SUFPRCxJQUFJLENBQUMsT0FBeUI7UUFDNUIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2xE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ZWN0YWJsZSwgSW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPdmVybGF5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xuaW1wb3J0IHsgQ29tcG9uZW50UG9ydGFsLCBQb3J0YWxJbmplY3RvciwgQ29tcG9uZW50VHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wb3J0YWwnO1xuaW1wb3J0IHsgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgSVVuaVRvYXN0IH0gZnJvbSAnLi90b2FzdC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSVVuaVRvYXN0T3B0aW9ucyB9IGZyb20gJy4vdG9hc3Qtb3B0aW9ucy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSVVuaVRvYXN0Q29uZmlnIH0gZnJvbSAnLi90b2FzdC1jb25maWcuaW50ZXJmYWNlJztcbmltcG9ydCB7IFVuaVRvYXN0UG9zaXRpb24gfSBmcm9tICcuL3RvYXN0LXBvc2l0aW9uLmVudW0nO1xuaW1wb3J0IHsgVW5pVG9hc3RDb21wb25lbnQgfSBmcm9tICcuL3RvYXN0LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBVTklfVE9BU1RfT1BUSU9OUyB9IGZyb20gJy4vdG9hc3Qtb3B0aW9ucy5jb25zdGFudCc7XG5pbXBvcnQgeyBVTklfVE9BU1RfQ09ORklHIH0gZnJvbSAnLi90b2FzdC1jb25maWcuY29uc3RhbnQnO1xuaW1wb3J0IHsgVW5pVG9hc3RSZWYgfSBmcm9tICcuL3RvYXN0LXJlZi5jbGFzcyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBVbmlUb2FzdFNlcnZpY2Uge1xuICBwcml2YXRlIF9pbmRleCA9IC0xO1xuICBwcml2YXRlIHJlYWRvbmx5IF90b2FzdHM6IElVbmlUb2FzdFtdID0gW107XG5cbiAgcHJpdmF0ZSBnZXQgX2lkKCkge1xuICAgIHRoaXMuX2luZGV4Kys7XG4gICAgcmV0dXJuIHRoaXMuX2luZGV4O1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChVTklfVE9BU1RfQ09ORklHKSBwcml2YXRlIHJlYWRvbmx5IF9jb25maWc6IElVbmlUb2FzdENvbmZpZyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9vdmVybGF5OiBPdmVybGF5LFxuICApIHt9XG5cbiAgb3BlbihvcHRpb25zOiBJVW5pVG9hc3RPcHRpb25zKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NyZWF0ZShVbmlUb2FzdENvbXBvbmVudCwgb3B0aW9ucyk7XG4gIH1cblxuICBjcmVhdGU8VD4oY29tcG9uZW50OiBDb21wb25lbnRUeXBlPFQ+LCBvcHRpb25zOiBJVW5pVG9hc3RPcHRpb25zKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NyZWF0ZShjb21wb25lbnQsIG9wdGlvbnMpO1xuICB9XG5cbiAgcmVtb3ZlKGlkOiBudW1iZXIpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3RvYXN0cy5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKHRoaXMuX3RvYXN0c1tpXS5pZCA9PT0gaWQpIHtcbiAgICAgICAgdGhpcy5fdG9hc3RzLnNwbGljZShpLCAxKTtcbiAgICAgICAgcmV0dXJuIGk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIC0xO1xuICB9XG5cbiAgZmluZDxUID0gYW55PihpZDogbnVtYmVyKTogSVVuaVRvYXN0PFQ+IHtcbiAgICByZXR1cm4gdGhpcy5fdG9hc3RzLmZpbmQodCA9PiB0LmlkID09PSBpZCk7XG4gIH1cblxuICBwcml2YXRlIF9jcmVhdGU8VD4oY29tcG9uZW50OiBDb21wb25lbnRUeXBlPFQ+LCBvcHRpb25zOiBJVW5pVG9hc3RPcHRpb25zKTogSVVuaVRvYXN0PFQ+IHtcbiAgICBjb25zdCBsYXRlc3QgPSB0aGlzLl9nZXRMYXRlc3RCeVBvc2l0aW9uKG9wdGlvbnMucG9zaXRpb24pO1xuICAgIGNvbnN0IHBvc2l0aW9uID0gbGF0ZXN0ID8gbGF0ZXN0LnJlZi5wb3NpdGlvbiA6IHVuZGVmaW5lZDtcbiAgICBjb25zdCBvdmVybGF5UmVmID0gdGhpcy5fb3ZlcmxheS5jcmVhdGUoe1xuICAgICAgcGFuZWxDbGFzczogb3B0aW9ucy5wYW5lbENsYXNzLFxuICAgICAgcG9zaXRpb25TdHJhdGVneTogdGhpcy5fZ2V0UG9zaXRpb25TdHJhdGVneShvcHRpb25zLnBvc2l0aW9uLCBwb3NpdGlvbiksXG4gICAgfSk7XG5cbiAgICBjb25zdCB0b2FzdFJlZiA9IG5ldyBVbmlUb2FzdFJlZihvdmVybGF5UmVmKTtcbiAgICBjb25zdCBwb3J0YWwgPSBuZXcgQ29tcG9uZW50UG9ydGFsKGNvbXBvbmVudCwgbnVsbCwgdGhpcy5fZ2V0SW5qZWN0b3IodG9hc3RSZWYsIG9wdGlvbnMpKTtcbiAgICBjb25zdCBpbnN0YW5jZSA9IG92ZXJsYXlSZWYuYXR0YWNoKHBvcnRhbCkuaW5zdGFuY2U7XG4gICAgY29uc3QgdG9hc3Q6IElVbmlUb2FzdDxUPiA9IHtcbiAgICAgIGlkOiB0aGlzLl9pZCxcbiAgICAgIHR5cGU6IG9wdGlvbnMudHlwZSxcbiAgICAgIHBvc2l0aW9uOiBvcHRpb25zLnBvc2l0aW9uLFxuICAgICAgY29tcG9uZW50OiBpbnN0YW5jZSxcbiAgICAgIHJlZjogdG9hc3RSZWYsXG4gICAgfTtcblxuICAgIHRvYXN0UmVmLmNsb3NlZCQucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5yZW1vdmUodG9hc3QuaWQpO1xuICAgICAgdGhpcy5fdXBkYXRlUG9zaXRpb25zKHRvYXN0LnBvc2l0aW9uKTtcbiAgICB9KTtcblxuICAgIHRoaXMuX3RvYXN0cy5wdXNoKHRvYXN0KTtcblxuICAgIHJldHVybiB0b2FzdDtcbiAgfVxuXG4gIHByaXZhdGUgX2dldEluamVjdG9yKHJlZjogVW5pVG9hc3RSZWYsIG9wdGlvbnM6IElVbmlUb2FzdE9wdGlvbnMpIHtcbiAgICBjb25zdCB0b2tlbnMgPSBuZXcgV2Vha01hcCgpO1xuXG4gICAgdG9rZW5zLnNldChVbmlUb2FzdFJlZiwgcmVmKTtcbiAgICB0b2tlbnMuc2V0KFVOSV9UT0FTVF9PUFRJT05TLCBvcHRpb25zKTtcbiAgICB0b2tlbnMuc2V0KFVOSV9UT0FTVF9DT05GSUcsIHRoaXMuX2NvbmZpZyk7XG5cbiAgICByZXR1cm4gbmV3IFBvcnRhbEluamVjdG9yKG51bGwsIHRva2Vucyk7XG4gIH1cblxuICBwcml2YXRlIF9nZXRQb3NpdGlvblN0cmF0ZWd5KHBvc2l0aW9uOiBVbmlUb2FzdFBvc2l0aW9uLCBsYXRlc3Q6IENsaWVudFJlY3QgfCBET01SZWN0KSB7XG4gICAgY29uc3QgcGIgPSB0aGlzLl9vdmVybGF5LnBvc2l0aW9uKCkuZ2xvYmFsKCk7XG5cbiAgICBpZiAocG9zaXRpb24gPT09IFVuaVRvYXN0UG9zaXRpb24uVG9wTGVmdCkge1xuICAgICAgcmV0dXJuIHBiLnRvcCh0aGlzLl9nZXRMYXRlc3RNYXJnaW4ocG9zaXRpb24sIGxhdGVzdCkpLmxlZnQoYCR7dGhpcy5fY29uZmlnLm1hcmdpbn1weGApO1xuICAgIH0gZWxzZSBpZiAocG9zaXRpb24gPT09IFVuaVRvYXN0UG9zaXRpb24uVG9wUmlnaHQpIHtcbiAgICAgIHJldHVybiBwYi50b3AodGhpcy5fZ2V0TGF0ZXN0TWFyZ2luKHBvc2l0aW9uLCBsYXRlc3QpKS5yaWdodChgJHt0aGlzLl9jb25maWcubWFyZ2lufXB4YCk7XG4gICAgfSBlbHNlIGlmIChwb3NpdGlvbiA9PT0gVW5pVG9hc3RQb3NpdGlvbi5Cb3R0b21MZWZ0KSB7XG4gICAgICBpZiAoIWxhdGVzdCkge1xuICAgICAgICByZXR1cm4gcGIuYm90dG9tKHRoaXMuX2dldExhdGVzdE1hcmdpbihwb3NpdGlvbiwgbGF0ZXN0KSkubGVmdChgJHt0aGlzLl9jb25maWcubWFyZ2lufXB4YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gcGIudG9wKHRoaXMuX2dldExhdGVzdE1hcmdpbihwb3NpdGlvbiwgbGF0ZXN0KSkubGVmdChgJHt0aGlzLl9jb25maWcubWFyZ2lufXB4YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFsYXRlc3QpIHtcbiAgICAgIHJldHVybiBwYi5ib3R0b20odGhpcy5fZ2V0TGF0ZXN0TWFyZ2luKHBvc2l0aW9uLCBsYXRlc3QpKS5yaWdodChgJHt0aGlzLl9jb25maWcubWFyZ2lufXB4YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBwYi50b3AodGhpcy5fZ2V0TGF0ZXN0TWFyZ2luKHBvc2l0aW9uLCBsYXRlc3QpKS5yaWdodChgJHt0aGlzLl9jb25maWcubWFyZ2lufXB4YCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0TGF0ZXN0TWFyZ2luKHBvc2l0aW9uOiBVbmlUb2FzdFBvc2l0aW9uLCBsYXRlc3Q/OiBDbGllbnRSZWN0IHwgRE9NUmVjdCkge1xuICAgIGNvbnN0IGtleToga2V5b2YgQ2xpZW50UmVjdCA9IChwb3NpdGlvbiA9PT0gVW5pVG9hc3RQb3NpdGlvbi5Ub3BMZWZ0IHx8IHBvc2l0aW9uID09PSBVbmlUb2FzdFBvc2l0aW9uLlRvcFJpZ2h0KSA/ICdib3R0b20nIDogJ3RvcCc7XG5cbiAgICBpZiAoa2V5ID09PSAnYm90dG9tJykge1xuICAgICAgcmV0dXJuIGxhdGVzdCA/IGAke2xhdGVzdFtrZXldICsgdGhpcy5fY29uZmlnLm1hcmdpbn1weGAgOiBgJHt0aGlzLl9jb25maWcubWFyZ2lufXB4YDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGxhdGVzdCA/IGAke2xhdGVzdFtrZXldIC0gbGF0ZXN0LmhlaWdodCAtIHRoaXMuX2NvbmZpZy5tYXJnaW59cHhgIDogYCR7dGhpcy5fY29uZmlnLm1hcmdpbn1weGA7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0VG9hc3RzQnlQb3NpdGlvbihwb3NpdGlvbjogVW5pVG9hc3RQb3NpdGlvbikge1xuICAgIHJldHVybiB0aGlzLl90b2FzdHMuZmlsdGVyKHQgPT4gdC5wb3NpdGlvbiA9PT0gcG9zaXRpb24pXG4gICAgICAgICAgICAgICAgICAgICAgIC5zb3J0KChhLCBiKSA9PiBhLmlkIC0gYi5pZCk7XG4gIH1cblxuICBwcml2YXRlIF9nZXRMYXRlc3RCeVBvc2l0aW9uKHBvc2l0aW9uOiBVbmlUb2FzdFBvc2l0aW9uKSB7XG4gICAgY29uc3QgdG9hc3RzID0gIHRoaXMuX2dldFRvYXN0c0J5UG9zaXRpb24ocG9zaXRpb24pO1xuICAgIHJldHVybiB0b2FzdHNbdG9hc3RzLmxlbmd0aCAtIDFdO1xuICB9XG5cbiAgcHJpdmF0ZSBfdXBkYXRlUG9zaXRpb25zKHBvc2l0aW9uOiBVbmlUb2FzdFBvc2l0aW9uKSB7XG4gICAgY29uc3QgdG9hc3RzID0gIHRoaXMuX2dldFRvYXN0c0J5UG9zaXRpb24ocG9zaXRpb24pO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b2FzdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRvYXN0c1tpXS5yZWYudXBkYXRlUG9zaXRpb24odGhpcy5fZ2V0UG9zaXRpb25TdHJhdGVneShcbiAgICAgICAgdG9hc3RzW2ldLnBvc2l0aW9uLFxuICAgICAgICB0b2FzdHNbaSAtIDFdID8gdG9hc3RzW2kgLSAxXS5yZWYucG9zaXRpb24gOiB1bmRlZmluZWQsXG4gICAgICApKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==